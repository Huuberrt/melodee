@page "/data/useredit/{ApiKey:guid}"
@page "/data/useredit/new"

@inherits MelodeeComponentBase
@using Melodee.Common.Data.Models
@using Melodee.Common.Data.Models.Extensions

@inject UserService UserService
@inject LibraryService LibraryService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject DefaultImages DefaultImages

<RadzenBreadCrumb Class="rz-pb-5">
    <RadzenBreadCrumbItem Path="/" Text="Dashboard"/>
    <RadzenBreadCrumbItem Path="/data/users" Text="Users"/>
    <RadzenBreadCrumbItem Icon="@(IsNew ? "add" : "edit")" Text="@(IsNew ? "Adding" : "Editing")"/>
  </RadzenBreadCrumb>

<RadzenStack>
    <RadzenRow>
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard>
                <RadzenImage Path="@_avatarImage" Style="width: 100%; height: auto;"/>
                <InputFile OnChange="@OnAvatarUpload" />
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenTemplateForm TItem="User" Data="@_user" Submit="@OnSubmit">
                <RadzenFieldset>
                    <RadzenStack Gap="0.75rem">
                        <RadzenTextBox @bind-Value="_user.UserName" Placeholder="Username" style="width:100%" />
                        <RadzenTextBox @bind-Value="_user.Email" Placeholder="Email" style="width:100%" />
                        @if (IsNew)
                        {
                            <RadzenPassword @bind-Value="_plainPassword" Placeholder="Password" style="width:100%" />
                        }
                        <RadzenSwitch @bind-Value="_user.IsLocked" Name="IsLocked" />
                        <RadzenLabel Text="Locked" Component="IsLocked"/>
                        <RadzenRadioButtonList TValue="int" TItem="RoleOption" @bind-Value="_roleChoice" Orientation="Orientation.Horizontal"
                                                Data="@_roleOptions"
                                                TextProperty="Text" ValueProperty="Value"/>
                        <RadzenButton Icon="save" Text="Save" ButtonType="ButtonType.Submit"/>
                    </RadzenStack>
                </RadzenFieldset>
            </RadzenTemplateForm>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    [Parameter] public Guid ApiKey { get; set; }
    bool IsNew => ApiKey == Guid.Empty;

    User _user = new()
    {
        UserName = string.Empty,
        UserNameNormalized = string.Empty,
        Email = string.Empty,
        EmailNormalized = string.Empty,
        PublicKey = string.Empty,
        PasswordEncrypted = string.Empty,
        CreatedAt = default
    };

    string _avatarImage = string.Empty;
    string _plainPassword = string.Empty;
    int _roleChoice = 0;
    class RoleOption { public int Value { get; set; } public string Text { get; set; } = string.Empty; }
    List<RoleOption> _roleOptions = new() { new RoleOption{ Value = 0, Text = "None" }, new RoleOption{ Value = 1, Text = "Editor" }, new RoleOption{ Value = 2, Text = "Admin" } };

    protected override async Task OnParametersSetAsync()
    {
        if (!IsNew)
        {
            var result = await UserService.GetByApiKeyAsync(ApiKey);
            if (result.Data != null)
            {
                _user = result.Data;
                _roleChoice = _user.IsAdmin ? 2 : _user.IsEditor ? 1 : 0;
            }
        }

        var userImageLibrary = await LibraryService.GetUserImagesLibraryAsync();
        var avatarFile = _user.ToAvatarFileName(userImageLibrary.Data.Path);
        _avatarImage = System.IO.File.Exists(avatarFile)
            ? $"data:image/gif;base64,{Convert.ToBase64String(await System.IO.File.ReadAllBytesAsync(avatarFile))}"
            : DefaultImages.UserAvatarBase64;
    }

    private async Task OnSubmit(User _)
    {
        if (IsNew)
        {
            var reg = await UserService.RegisterAsync(_user.UserName, _user.Email, _plainPassword, null);
            if (!reg.IsSuccess || reg.Data == null)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = string.Join(";", reg.Messages ?? []) });
                return;
            }
            _user = reg.Data;
        }

        _user.IsAdmin = _roleChoice == 2;
        _user.IsEditor = _roleChoice == 1;

        var original = await UserService.GetByApiKeyAsync(_user.ApiKey);
        var save = await UserService.UpdateAsync(original.Data!, _user);
        NotificationService.Notify(new NotificationMessage { Severity = save.IsSuccess ? NotificationSeverity.Success : NotificationSeverity.Error, Summary = save.IsSuccess ? "Saved" : "Error", Detail = save.IsSuccess ? "User saved" : string.Join(";", save.Messages ?? []) });
        if (save.IsSuccess)
        {
            NavigationManager.NavigateTo("/data/users", true);
        }
    }

    private async Task OnAvatarUpload(InputFileChangeEventArgs e)
    {
        await using var ms = new MemoryStream();
        await e.File.OpenReadStream(MelodeeConfiguration.MaximumUploadFileSize).CopyToAsync(ms);
        var save = await UserService.SaveProfileImageAsync(_user.Id, ms.ToArray());
        NotificationService.Notify(new NotificationMessage { Severity = save.IsSuccess ? NotificationSeverity.Success : NotificationSeverity.Error, Summary = save.IsSuccess ? "Saved" : "Error", Detail = save.IsSuccess ? "Avatar updated" : string.Join(";", save.Messages ?? []) });
        await OnParametersSetAsync();
        StateHasChanged();
    }
}
